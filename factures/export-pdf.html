<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export PDF - SmartFlow</title>
    <!-- Biblioth√®que jsPDF pour la g√©n√©ration PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Styles pour la page d'export */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
        }

        h1 {
            color: #0B0B12;
            margin-bottom: 24px;
            font-size: 32px;
        }

        .button-group {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a78bfa 0%, #22d3ee 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(167, 139, 250, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #0B0B12;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #a78bfa;
        }

        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
        }

        .info-box h3 {
            color: #0B0B12;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .info-box ul {
            list-style: none;
            padding: 0;
        }

        .info-box li {
            color: #6B7280;
            margin-bottom: 8px;
            padding-left: 24px;
            position: relative;
        }

        .info-box li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #a78bfa;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6B7280;
        }

        .loading.active {
            display: block;
        }

        #invoicePreview {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Export PDF de la Facture</h1>
        
        <div class="info-box">
            <h3>Instructions</h3>
            <ul>
                <li>Le fichier HTML sera converti en PDF avec un rendu fid√®le</li>
                <li>Les gradients et effets visuels seront pr√©serv√©s</li>
                <li>Le fichier PDF sera t√©l√©charg√© automatiquement</li>
                <li>V√©rifiez que tous les placeholders sont remplis avant l'export</li>
            </ul>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="generatePDF()">
                üìÑ G√©n√©rer et t√©l√©charger le PDF
            </button>
            <button class="btn btn-secondary" onclick="window.open('template-facture.html', '_blank')">
                üëÅÔ∏è Aper√ßu HTML
            </button>
        </div>

        <div class="loading" id="loading">
            G√©n√©ration du PDF en cours... Veuillez patienter.
        </div>
    </div>

    <!-- Aper√ßu invisible pour capture -->
    <iframe id="invoicePreview" src="template-facture.html" style="display: none; width: 900px; height: 1200px;"></iframe>

    <script>
        async function generatePDF() {
            const loading = document.getElementById('loading');
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            try {
                // Afficher le loading
                loading.classList.add('active');
                btn.disabled = true;
                btn.innerHTML = '‚è≥ G√©n√©ration en cours...';
                
                // Attendre que l'iframe soit charg√©e
                const iframe = document.getElementById('invoicePreview');
                iframe.style.display = 'block';
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Capturer le contenu de l'iframe
                const content = iframe.contentDocument || iframe.contentWindow.document;
                
                // Utiliser html2canvas pour capturer
                const canvas = await html2canvas(content.body, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: 900,
                    windowWidth: 900
                });
                
                // Cr√©er le PDF avec jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Calculer les dimensions pour A4
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Ajouter l'image au PDF
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                
                // G√©n√©rer un nom de fichier avec la date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const filename = `facture-smartflow-${dateStr}.pdf`;
                
                // T√©l√©charger le PDF
                pdf.save(filename);
                
                loading.classList.remove('active');
                btn.disabled = false;
                btn.innerHTML = originalText;
                iframe.style.display = 'none';
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration PDF:', error);
                alert('Une erreur est survenue lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
                loading.classList.remove('active');
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('invoicePreview').style.display = 'none';
            }
        }

        // V√©rifier que les biblioth√®ques sont charg√©es
        window.addEventListener('load', () => {
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas n\'est pas charg√©');
            }
            if (typeof window.jspdf === 'undefined') {
                console.error('jsPDF n\'est pas charg√©');
            }
        });
    </script>
</body>
</html>

